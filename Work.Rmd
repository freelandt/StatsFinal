---
title: "WorkFile"
author: "Trevor Freeland"
date: "May 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(stargazer)
library(lme4)
library(tidyr)
library(MASS)
library(pscl)
library(HLMdiag)

model.counts <- source("http://math.carleton.edu/Chihara/Stats345/Count_Function.R")$value
```

```{r}
#Does the data read
VideoGames <- read.csv("VideoGames.csv") #16719 cases
VideoGames$Year_of_Release <- as.numeric(as.character(VideoGames$Year_of_Release))
VideoGames$User_Score <- as.numeric(as.character(VideoGames$User_Score))
VideoGames <- na.omit(VideoGames) #6894 full cases. 
VideoGames$Rating2 <- as.factor(ifelse(VideoGames$Rating %in% c("E", "E10+", "M", "T"), as.character(VideoGames$Rating), "No Rating"))

#Create "Other" category for publishers/developers that worked on 10 games or less
Publishers <- VideoGames %>% group_by(Publisher) %>% summarize(n = n())
Publishers$Publisher2 <- as.factor(ifelse(Publishers$n > 10, as.character(Publishers$Publisher), "Other"))
VideoGames2 <- merge(VideoGames, Publishers[,c(1,3)], by.x = "Publisher", by.y = "Publisher")

Developers <- VideoGames %>% group_by(Developer) %>% summarize(n = n())
Developers$Developer2 <- as.factor(ifelse(Developers$n > 10, as.character(Developers$Developer), "Other"))
VideoGames2 <- merge(VideoGames2, Developers[,c(1,3)], by.x = "Developer", by.y = "Developer")
```

##Some EDA

```{r}
edaData <- VideoGames %>% gather(Region, Sales, c("NA_Sales", "EU_Sales", "JP_Sales", "Other_Sales"))

edaData2 <- edaData %>% group_by(Region, Genre) %>% mutate(Percent = Sales/sum(Global_Sales))

ggplot(edaData2, aes(x = Genre, y = Percent, fill = Region)) + geom_bar(stat = "identity")

ggplot(edaData, aes(x = Genre, y = Sales, fill = Region)) + geom_bar(stat = "identity")
```

```{r}
temp <- VideoGames %>% filter(NA_Sales >0, EU_Sales >0, JP_Sales > 0)

temp <- VideoGames %>% group_by(Developer) %>% summarise(n = n())

temp2 <- temp %>% filter(n > 10)
hist(temp$n)
```

```{r}
na.sales <- zeroinfl((NA_Sales*100)~Year_of_Release+Genre+Critic_Score+User_Score+Rating2+Platform, data = VideoGames2, dist = "negbin")

na.sales2 <- glmer((NA_Sales*100)~Year_of_Release + Genre + Critic_Score+User_Score+Rating2 + (1|Publisher2) + (1|Platform), data = VideoGames2, family = poisson)
summary(na.sales2)
```

```{r}
x <- HLMresid(na.sales2, level="marginal", standardize = TRUE)

#standardized marginal: curvature? outliers?

plot(x ~ fitted(na.sales2), data = VideoGames2)
abline(h= 0)

#residuals in order of observation number

plot(x)
abline(h = 0)

#standardized conditional
x2 <- HLMresid(na.sales2, level = 1, standardize = TRUE)

#constant variance? outliers?
plot(fitted(na.sales2), x2)
abline(h= 0)

#in order of observation number
plot(x2)

cd <- cooks.distance(na.sales2)
plot(cd, type = "h") #using base R plot
dotplot_diag(cd, cutoff="internal", name="cooks.distance")
```

